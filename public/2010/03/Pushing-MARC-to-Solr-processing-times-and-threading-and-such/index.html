<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="description" content="">
	<meta property="og:title" content="Pushing MARC to Solr; processing times and threading and such">
	<link rel="icon" href="http://robotlibrarian.billdueber.com/" />
	
	
		<title>Robot Librarian | Pushing MARC to Solr; processing times and threading and such</title>
		<meta property="og:type" content="article">
		<meta property="article:published_time" content= 2010-03-04 >
	
	<meta property="og:description" content="">
	<meta property="og:url" content="http://robotlibrarian.billdueber.com/2010/03/pushing-marc-to-solr-processing-times-and-threading-and-such/">
	<meta property="og:site_name" content="Robot Librarian">
	
	<meta name="generator" content="Hugo 0.24.1" />
   
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

	
	<link rel="stylesheet" href="http://robotlibrarian.billdueber.comcss/style.css">
	<link href="" rel="alternate" type="application/rss+xml" title="Robot Librarian" />
</head>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://robotlibrarian.billdueber.com">Robot Librarian</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="particles-js"></div>
	<div id="menu-content" class="vertical-align">
		<img src="/images/robot_alpha.png" class="center-block" alt="Cheesy picture of robot">
		
			<h1 class="text-center"><a href="http://robotlibrarian.billdueber.com">Robot Librarian</a></h1>
		
		
		
			<small class="text-center center-block">Bill Dueber</small>
		
		
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/billdueber" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>
				
			
			
			
			<a href="https://github.com/https://github.com/billdueber" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
				
			<a href="mailto:bill@dueber.com" target="_blank"><i class="fa fa-envelope fa-2x"></i></a>			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>


		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<div class="panel-header">
			<h1>Pushing MARC to Solr; processing times and threading and such
				
			</h1>
			<div class="panel-footer">
				
			</div>
			
		</div>
	</header>
	<br>
	<HR align=center>
	<article>
		

<p>[This is in response to a <a href="http://groups.google.com/group/blacklight-development/browse_thread/thread/672b7269ada16a61?hl=en">thread on the blacklight mailing</a> list about getting MARC data into Solr.]</p>

<h3 id="what-s-the-question">What&rsquo;s the question?</h3>

<p>The question came up, &ldquo;How much time do we spend processing the MARC vs trying to push it into Solr?&rdquo;. Bob Haschart found that even with a pretty damn complicated processing stage, pushing the data to solr was still, at best,
taking at least as long as the processing stage.</p>

<p>I&rsquo;m interested because I&rsquo;ve been struggling to write a solrmarc-like system that runs under JRuby. Architecturally, the big difference between my stuff and solrmac is that I use the StreamingUpdateSolrServer (on Erik Hatcher&rsquo;s suggestion). So I thought I&rsquo;d check how things break down for me.</p>

<p>Here are my numbers running under JRuby (using MARC4J as the marc
implementation) with the Solr StreamingUpdateSolrServer. Obviously, there are
a lot of differences between this and solrmarc, but I&rsquo;m hoping that while it&rsquo;s
not comparing apples to apples, it&rsquo;s at least comparing apples to some sort of
processed cheese-like product.</p>

<h3 id="what-work-is-being-done-on-what">What work is being done on what?</h3>

<p>The data set is a file of 18,881 MARC records in marc-binary format. It&rsquo;s
probably not big enough to get a great idea of how things will run over the
long (many millions of records) haul, but it&rsquo;ll do for this rough-cut stuff.</p>

<p>I break my processing down into five categories:</p>

<ul>
<li>Read the records into marc4j objects and do nothing. This is a baseline of sorts.</li>
<li>The &ldquo;normal&rdquo; fields are anything that you could do with SolrMarc without a
custom routine; the actual processing is done in JRuby.</li>
<li>Custom fields are generated with JRuby code, but these are things that in solmarc would require a custom routine.</li>
<li>The big &ldquo;allfields&rdquo; field is text from tags 100 through 900.</li>
<li>The &ldquo;to_xml&rdquo; routine is just calling the underlying marc4j XML output and stuffing it into a string.</li>
</ul>

<p>The schema used is our normal UMICH schema <em>except for</em> High Level Browse
(which appear in the <a href="http://mirlyn.lib.umich.edu/">our catalog</a> as &ldquo;Academic
Discipline&rdquo;). The code for that is written in Java, and I just call it from
JRuby when I&rsquo;m using it. I excluded it because it&rsquo;s incredibly expensive, both at startup time (when it loads a giant database of call-number ranges and associated categories) and for processing &ndash; there&rsquo;s a lot of call-number normalization, long-string comparisons, some modified binary searches, etc. etc. etc. It&rsquo;s expensive. Trust me.</p>

<p>The Solr server itself is on a different, incredibly-beefy machine, and is
emptied out before each invocation that involves actually pushing data to it (with a delete-by-query <em>:</em>).</p>

<h3 id="how-fast-were-things-on-my-desktop">How fast were things on my desktop?</h3>

<ul>
<li>18,881 records in marc-binary format</li>
<li>Times are in seconds, run on my desktop</li>
<li>Remember, you can&rsquo;t compare these numbers to Bob&rsquo;s because we&rsquo;re doing
different things to different data.</li>
</ul>

<table>
<thead>
<tr>
<th>Total Seconds</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>19</td>
<td>Just read the records with marc4j and do nothing.</td>
</tr>

<tr>
<td>85</td>
<td>Read and do 35 &ldquo;normal&rdquo; fields (no custom)</td>
</tr>

<tr>
<td>104</td>
<td>Read, 35 normal, 15 custom fields</td>
</tr>

<tr>
<td>110</td>
<td>Read, normal, custom, allfields</td>
</tr>

<tr>
<td>129</td>
<td>Read, normal, custom, allfields, to_xml</td>
</tr>

<tr>
<td>136</td>
<td>Read, normal, custom, allfields, to_xml, 2-threaded SUSS, commit every 5K docs</td>
</tr>

<tr>
<td>142</td>
<td>Read, normal, custom, allfields, to_xml, 1-threaded SUSS, commit every 5k docs</td>
</tr>

<tr>
<td>124</td>
<td>Read, normal, custom, allfields, to_xmx, 1-threaded SUSS, commit every 5k docs, <strong>2 threads doing processing</strong></td>
</tr>
</tbody>
</table>

<p>We can also break the same numbers down as:</p>

<table>
<thead>
<tr>
<th>Seconds</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>19</td>
<td>read the records and do nothing</td>
</tr>

<tr>
<td>66</td>
<td>process the 35 normal fields</td>
</tr>

<tr>
<td>19</td>
<td>process the 15 custom fields</td>
</tr>

<tr>
<td>6</td>
<td>generate the &ldquo;allfields&rdquo; field</td>
</tr>

<tr>
<td>19</td>
<td>generate the XML (yowza!)</td>
</tr>

<tr>
<td>7</td>
<td>send to solr with two threads</td>
</tr>

<tr>
<td>13</td>
<td>send to solr with one thread</td>
</tr>
</tbody>
</table>

<p>Or like this:</p>

<table>
<thead>
<tr>
<th>Seconds</th>
<th>Description</th>
</tr>
</thead>

<tbody>
<tr>
<td>129</td>
<td>do all the reading and processing</td>
</tr>

<tr>
<td>13</td>
<td>send to solr with one thread</td>
</tr>
</tbody>
</table>

<h3 id="why-does-solr-processing-seem-so-much-faster-for-me">Why does solr processing seem so much faster for me?</h3>

<p>There are a lot of reasons why my submit-to-solr might seem like less of a
burden. The ones I can think of off the top of my head are:</p>

<ul>
<li>SUSS is just faster than whatever solrmarc does.</li>
<li>My processing stage is so much slower than solrmac&rsquo;s (due to algorithms or jruby-vs-java, I don&rsquo;t know) that the &ldquo;push to solr&rdquo; portion of it gets swallowed up by the slowness of the of overall code.</li>
<li>The Solr server is so much faster than my desktop that my poor little
desktop can&rsquo;t send it data fast enough to work it.</li>
</ul>

<p><strong>For my setup, obviously adding a processing thread is a lot more beneficial
than adding a SUSS thread.</strong> My desktop doesn&rsquo;t have that many threads lying around (adding a third processing thread actually slowed things down), so I moved the code to a beefier machine to see what happened.</p>

<h3 id="trying-the-same-thing-on-a-beefy-machine">Trying the same thing on a beefy machine</h3>

<p>This is the exact same code and data, but on a beefy machine (16 cores, gobs
of memory).</p>

<table>
<thead>
<tr>
<th align="right">time</th>
<th align="center">SUSS Threads</th>
<th align="center">Processing Threads</th>
</tr>
</thead>

<tbody>
<tr>
<td align="right">70</td>
<td align="center">1</td>
<td align="center">1     (was 142 seconds on the desktop)</td>
</tr>

<tr>
<td align="right">47</td>
<td align="center">1</td>
<td align="center">2</td>
</tr>

<tr>
<td align="right">39</td>
<td align="center">1</td>
<td align="center">3</td>
</tr>

<tr>
<td align="right">35</td>
<td align="center">1</td>
<td align="center">4</td>
</tr>

<tr>
<td align="right">68</td>
<td align="center">2</td>
<td align="center">1</td>
</tr>

<tr>
<td align="right">48</td>
<td align="center">2</td>
<td align="center">2</td>
</tr>

<tr>
<td align="right">38</td>
<td align="center">2</td>
<td align="center">3</td>
</tr>

<tr>
<td align="right">34</td>
<td align="center">2</td>
<td align="center">4</td>
</tr>
</tbody>
</table>

<p>So, on my hardware anyway, there&rsquo;s a sweet spot with one suss thread and
three processing threads. YMMV, of course.</p>

<h3 id="what-have-we-learned">What have we learned?</h3>

<p>I&rsquo;m not sure, to be honest. It&rsquo;s logistically difficult for me to do the same
process in solrmarc because I&rsquo;d have to rebuild everything without the HLB stuff. I guess for me, what I&rsquo;ve learned that if I&rsquo;m going to continue working
on my code, the places to focus my attention are threading (obviously) and MARC-XML generation.</p>

	</article>
	<br>
	
</main>
	


						<br>
						<section id="footer">
							<div class="text-center center-block">
								<ul class="copyright">
									<li>&copy; 2017 <a target="_blank" href="http://robotlibrarian.billdueber.com"></a> | Powered by <a target="_blank" href="https://gohugo.io/">Gohugo</a> | Theme <a target="_blank" href="https://git.pofilo.fr/pofilo/hugo-fatboy">Fatboy</a></li>
								</ul>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
	</div>
  
  
	
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

	

	

	

	

	
	</body>
</html>





