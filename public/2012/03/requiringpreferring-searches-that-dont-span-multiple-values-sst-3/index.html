<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="description" content="">
	<meta property="og:title" content="Requiring/Preferring searches that don&#39;t span multiple values (SST #3)">
	<link rel="icon" href="http://robotlibrarian.billdueber.com/" />
	
	
		<title>Robot Librarian | Requiring/Preferring searches that don&#39;t span multiple values (SST #3)</title>
		<meta property="og:type" content="article">
		<meta property="article:published_time" content= 2012-03-09 >
	
	<meta property="og:description" content="">
	<meta property="og:url" content="http://robotlibrarian.billdueber.com/2012/03/requiringpreferring-searches-that-dont-span-multiple-values-sst-3/">
	<meta property="og:site_name" content="Robot Librarian">
	
		<meta property="og:tags" content="phrase slop">
	
		<meta property="og:tags" content="solr">
	
		<meta property="og:tags" content="Stupid Solr Tricks">
	
	<meta name="generator" content="Hugo 0.24.1" />
   
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

	
	<link rel="stylesheet" href="http://robotlibrarian.billdueber.comcss/style.css">
	<link href="" rel="alternate" type="application/rss+xml" title="Robot Librarian" />
</head>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://robotlibrarian.billdueber.com">Robot Librarian</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="particles-js"></div>
	<div id="menu-content" class="vertical-align">
		<img src="/images/robot_alpha.png" class="center-block" alt="Cheesy picture of robot">
		
			<h1 class="text-center"><a href="http://robotlibrarian.billdueber.com">Robot Librarian</a></h1>
		
		
		
			<small class="text-center center-block">Bill Dueber</small>
		
		
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/billdueber" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>
				
			
			
			
			<a href="https://github.com/https://github.com/billdueber" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
				
			<a href="mailto:bill@dueber.com" target="_blank"><i class="fa fa-envelope fa-2x"></i></a>			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>


		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<div class="panel-header">
			<h1>Requiring/Preferring searches that don&#39;t span multiple values (SST #3)
				
			</h1>
			<div class="panel-footer">
				
					<small class="text-muted">
						
						
							<font size="4"><a href="http://robotlibrarian.billdueber.comtags/phrase-slop"><span class="label label-success">phrase slop</span></a></font>
						
							<font size="4"><a href="http://robotlibrarian.billdueber.comtags/solr"><span class="label label-success">solr</span></a></font>
						
							<font size="4"><a href="http://robotlibrarian.billdueber.comtags/stupid-solr-tricks"><span class="label label-success">Stupid Solr Tricks</span></a></font>
						
					</small>
				
			</div>
			
		</div>
	</header>
	<br>
	<HR align=center>
	<article>
		

<blockquote>
<p>Check out <a href="http://robotlibrarian.billdueber.com/stupid-solr-tricks-introduction/">introduction to the Stupid Solr Tricks series</a> if you&rsquo;re just joining us.]</p>
</blockquote>

<h3 id="solr-and-multivalued-fields">Solr and multiValued fields</h3>

<p>Here&rsquo;s another thing you need to understand about Solr: it doesn&rsquo;t really have fields that can take multiple values.</p>

<p>&ldquo;But Bill,&rdquo; you&rsquo;re saying, &ldquo;sure it does. I mean, hell, it even has a &lsquo;multiValued&rsquo; parameter.&rdquo;</p>

<p>First off: watch your language.</p>

<p>Second off: are you <em>sure</em>?</p>

<p>Let&rsquo;s do a quick test. Look at the following documents</p>

<pre><code class="language-javascript">exampledocs/names.json
[
  {
    &quot;id&quot;: &quot;1&quot;,
    &quot;title&quot;: &quot;The Monkees&quot;,
    &quot;name_text&quot;: [&quot;Peter Tork&quot;, &quot;Mike Nesmith&quot;,
                  &quot;Micky Dolenz&quot;, &quot;Davy Thomas Jones&quot;]
  },
  {
    &quot;id&quot;: &quot;2&quot;,
    &quot;title&quot;: &quot;Heros of the Wild West&quot;,
    &quot;name_text&quot;: [&quot;Buck Jones&quot;, &quot;Davy Crockett&quot;]
  }
]

</code></pre>

<p>Question: what do you get when you run this query against those two documents?</p>

<pre><code class="language-ruby">ruby/names_query.rb
{
  'fl' =&gt; 'score, *',
  'defType' =&gt; 'dismax',
  'wt' =&gt; 'csv',
  'qf' =&gt; 'name_text',
  'q' =&gt; 'davy jones'   # Poor guy just died. So young. So short.
}

</code></pre>

<p>See how I threw the <em>wt=csv</em> in there? Check out <a href="http://lucene.apache.org/solr/api/org/apache/solr/response/QueryResponseWriter.html">all the query response formats</a> if you&rsquo;re interested, but really all you&rsquo;ll use is <code>standard</code> (XML), <code>json</code>, or <code>csv</code> unless you&rsquo;re rolling your own in some way.</p>

<p>I&rsquo;ve updated <code>ruby/browse.rb</code> to allow a second argument of the type of output you want. You can now do <code>ruby browse.rb jsonfile [json|csv|standard|xml]</code></p>

<h3 id="following-along-at-home">Following along at home?</h3>

<p>If so, let&rsquo;s go ahead and index these document and run the query.</p>

<pre><code class="language-bash">Play along at home
cd solr_stupid_tricks
git pull origin master
git fetch --all
git checkout SST3 # I've started tagging the repo for these posts
# ignore warning about &quot;detached HEAD&quot;
java -jar start.jar &amp;
cd exampledocs
 ./reset_and_index_json.sh names.json
 cd ../ruby
 ruby browse.rb names_query.rb

</code></pre>

<p>Here&rsquo;s the scores that I get:</p>

<pre><code class="language-csv">Return from Solr
  id,title,name_text,score
  2,Heros of the Wild West,&quot;Buck Jones,Davy Crockett&quot;,0.42039964
  1,The Monkees,&quot;Peter Tork,Mike Nesmith,Micky Dolenz,Davy Thomas Jones&quot;,0.26274976

</code></pre>

<p>Check out that last column. The query was <em>davy jones</em>. Document #1 contains a name that has both those terms, but document #2 (which has both terms, but in different names) gets a higher score.</p>

<h3 id="the-relevance-ranking-seems-wrong">The relevance ranking seems&hellip;wrong</h3>

<p>While it <em>looks</em> like we added four separate names to the <code>name_text</code> field in our first document, Solr doesn&rsquo;t see it that way. Solr treats those four poor Monkees as if they had one long name.</p>

<p>Then it finds all the documents that match the query (both of our documents match) and figures out which is a better match by assigning a score.</p>

<p>In this case, while both document have both query terms, the field in the second document is <em>shorter</em>. Which means that, essentially, a <em>higher percentage of the terms in the field value match the given  query terms</em>. In Solr&rsquo;s mind, that makes it a better match, and the shorter document shows up first.</p>

<p>Solr doesn&rsquo;t automatically give more weight to the recently-dead Monkee because internally it doesn&rsquo;t care that you&rsquo;re thinking of those values as four separate names. It just concatenates them together and indexes them.</p>

<p>This is <strong>not</strong>, for most people, expected behavior.</p>

<h3 id="phrase-slop">Phrase slop</h3>

<p>Part of what&rsquo;s going on here is that we haven&rsquo;t told Solr that it should care how close together the terms are.</p>

<p>One way to do that is to use a phrase query by throwing quotes around the terms</p>

<pre><code class="language-ruby">Put double-quotes around it to make it a phrase query
  &quot;q&quot; =&gt; '&quot;Davy Jones&quot;'

</code></pre>

<p>&hellip;but that won&rsquo;t find anything, because <em>Davy</em> and <em>Jones</em> aren&rsquo;t right next to each other in our document.</p>

<p>Solr does allow a phrase query to be &ldquo;sloppy&rdquo;, though &ndash; basically saying that instead of being right next to each other, the terms need to be within a certain number of tokens of each other.</p>

<p>For that, we&rsquo;ll tell solr to search against certain fields (<code>pf</code>) treating the query as a phrase, and allow a little slop (<code>ps</code>) as well.</p>

<pre><code class="language-ruby">ruby/names_sloppy_query.rb
  {
    'fl' =&gt; 'score, *',
    'defType' =&gt; 'dismax',
    'wt' =&gt; 'csv',
    'q' =&gt; 'davy jones',
    'qf' =&gt; 'name_text',
    'pf' =&gt; 'name_text^10', # search this field as a phrase
    'ps' =&gt; '4' # allow 'phrase' to mean 'within 4 tokens of each other'
  }  

</code></pre>

<p>That gets us something more expected.</p>

<pre><code class="language-csv">
  id,title,name_text,score
  1,The Monkees,&quot;Peter Tork,Mike Nesmith,Micky Dolenz,Davy Thomas Jones&quot;,0.2806283
  2,Heros of the Wild West,&quot;Buck Jones,Davy Crockett&quot;,0.029652705

</code></pre>

<h3 id="enter-positionincrementgap">Enter <code>positionIncrementGap</code></h3>

<p>OK. Now that we have the concept of &ldquo;slop&rdquo;, one of those mystery <code>fieldtype</code> parameters makes sense: <code>positionIncrementGap</code>. Basically, a <code>positionIncrementGap</code> of 1000 means <em>When computing slop, pretend there are 1000 tokens between the entries in a multValued field</em>.</p>

<p>A sloppy phrase search, then, will only find (and thus boost) the phrase if (a) the tokens are in the same entry for a multiValued field, and (b) your slop value is less than your <code>positionIncrementGap</code>.</p>

<p>All you have to do is use the <code>pf</code> and <code>ps</code> parameters and you&rsquo;re set.</p>

<p>Note that this should be telling you two things:</p>

<ul>
<li><strong>Always use the same positionIncrementGap for your multiValued fields</strong></li>
<li><strong>Make it a number much larger than the maximum number of tokens you expect to ever have in a field.</strong></li>
</ul>

<p>Note that a large <code>positionIncrementGap</code> doesn&rsquo;t <em>actually</em> put 1000 tokens in there &ndash; a large value doesn&rsquo;t affect processing time or your index size or anything.</p>

<h3 id="but-i-m-already-using-the-pf-parameter">But I&rsquo;m already using the <code>pf</code> parameter!</h3>

<p>Slop is great when you want it. But I don&rsquo;t always want to use slop. Slop of 4 makes the phrase &ldquo;<em>Sex in the City</em>&rdquo; be treated exactly the same as &ldquo;<em>In the Sex City</em>&rdquo;. If someone puts in an exact title, I want to reward them for that query by floating the exact match to the top, and slop prevents me from doing so.</p>

<p>[<em>Forshadowing</em>: We&rsquo;ll talk about exact-ish matches in a few days.]</p>

<p>OK, so we can&rsquo;t just appropriate the <code>pf</code>/<code>ps</code> parameters and and push the slop value up all the time &ndash; that cripples our ability to create the query boost structure we want.</p>

<h3 id="query-slop">Query slop</h3>

<p>So, dismax (and its cousin edismax) have an analogous parameter that affects only <em>phrases within</em> the normal query: <code>qs</code>.</p>

<p><code>qs</code> is a dismax param that affects <em>query slop</em> &ndash; how much slop to allow in phrases within the query, much like the <code>ps</code> param.</p>

<p>The query</p>

<pre><code class="language-ruby">A three-token query
  'q' =&gt; 'Bill &quot;The Weasel&quot; Dueber'

</code></pre>

<p>&hellip;has three tokens, the second of which (<em>&ldquo;The Weasel&rdquo;</em>) is a phrase. It&rsquo;s that phrase token that is affected by query slop.</p>

<p>OK. So it affects only the phrases in the normal query. But&hellip;suppose we just force the <em>entire</em> query to be one big phrase? That&rsquo;ll get us somewhere!</p>

<p>We just need to do the following:</p>

<ul>
<li>Create a boost query that uses the same fields as the regular query</li>
<li>&hellip;but treats all the query terms as one big phrase</li>
<li>&hellip;and give it a query slop of one less that the <code>positionIncrementGap</code> in our field type definition (in my case, 999)</li>
</ul>

<h3 id="package-it-up">Package it up</h3>

<p>OK, so here&rsquo;s what we&rsquo;re going to do. You can just take this basic idea and build it into your own queries in your application code. Try it. You might like it. Play around with what fields are affected, how much weight to give it, etc.</p>

<p>But heck, we&rsquo;ve gone this far. Let&rsquo;s encode it into the Solr configuration file <code>solrconfig.xml</code> itself as a custom request handler.</p>

<p>We&rsquo;re going to extend our <code>edismaxplus</code> requestHandler from <a href="http://robotlibrarian.billdueber.com/using-localparams-in-solr-sst-2/">last time</a>, but we&rsquo;ll add an extra boost query that reflects this new &ldquo;prefer documents where all the tokens appear in the same &lsquo;line&rsquo; of a multiValued query&rdquo; attitude.</p>

<p><strong>solr/conf/solrconfig.xml</strong></p>

<pre><code class="language-xml">&lt;requestHandler name=&quot;/edismaxplus&quot; class=&quot;solr.SearchHandler&quot;&gt;
  &lt;lst name=&quot;defaults&quot;&gt;
    &lt;str name=&quot;rows&quot;&gt;10&lt;/str&gt;
    &lt;str name=&quot;fl&quot;&gt;*,score&lt;/str&gt;
    &lt;str name=&quot;echoParams&quot;&gt;explicit&lt;/str&gt;
    &lt;str name=&quot;q&quot;&gt;
      _query_:&quot;{!edismax qf=$fields mm=$mymm
                          v=$qwords bq=$boostForAll}&quot;&lt;/str&gt;
    &lt;str name='mymm'&gt;0%&lt;/str&gt;
    &lt;str name=&quot;qwordsphrase&quot;&gt;&quot;JunkThatWillNEverShowUpInAMillionFreakinYears&quot;&lt;/str&gt;
    &lt;str name='boostForAll'&gt;
      _query_:&quot;{!edismax qf=$fields
                         mm='100%'
                         v=$qwords }&quot;^5 OR
      _query_:&quot;{!dismax  qf=$fields
                         mm='100%'
                         v=$qwordsphrase
                         qs='999'}&quot;^5
    &lt;/str&gt;
  &lt;/lst&gt;
&lt;/requestHandler&gt;  

</code></pre>

<p>We now do a few new things:</p>

<ul>
<li>(<em>Line 15</em>) Add a second clause to the boost query that use the same fields provided for the regular query (note the boolean OR between the two localparams queries that comprise this boost query)</li>
<li>(<em>Line 17</em>) Ask for another user-provided value: <code>qwordsphrase</code> which your application-level stuff should set to the set of all the regular query ters, but as a single phrase. Basically, strip out all the double-quotes, then put the whole thing in double quotes. In ruby: <code>qwordsphrase = '&quot;' + qwords.gsub(/&quot;/, '&quot;') + '&quot;'</code></li>
<li>(<em>Line 10</em>) Provide a default value for the new <code>qwordsphrase</code> that won&rsquo;t ever show up in a real query (empty string won&rsquo;t work; I tried it and it throws an error). So, if the application doesn&rsquo;t provide <code>qwordsphrase</code>, no harm is done &ndash; the search regresses to what we had last time.</li>
<li>(<em>Line 18</em>) Use a <code>qs</code> (query slop) of 999 in the new boost clause acting against <code>qwordsphrase</code>. That value is one less than the <code>positionIncrementGap</code> of 1000, making sure that we don&rsquo;t cross multiValue boundaries.</li>
</ul>

<p><strong>Note</strong>: If you wanted to, you could make this a filter query (<code>fq</code>) instead of a boost query to <em>only</em> allow documents that meet this criterion.</p>

<h3 id="let-s-try-it-out">Let&rsquo;s try it out!</h3>

<p>Once again, if you did a <code>git pull origin master</code> you&rsquo;ve got this up and running already &ndash; the updated requestHandler source is already in <code>solr/conf/solrconfig.xml</code>.</p>

<p>We first construct the query just like we did last week, without the <code>qwordsphrase</code> argument:</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=davy%20jones&amp;amp;fields=name_text">http://localhost:8983/solr/edismaxplus/?qwords=davy jones&amp;fields=name_text</a></p>

<p>You&rsquo;ll see Davy Crockett and friend appear as the first item.</p>

<p>But when you add the phraseified query, you&rsquo;ll see the boost we&rsquo;ve been talking about this whole post and get something more expected.</p>

<p><a href="http://localhost:8983/solr/edismaxplus/?qwords=davy%20jones&amp;amp;fields=name_text&amp;amp;qwordsphrase=%22Davy%20Jones%22">http://localhost:8983/solr/edismaxplus/?qwords=davy jones&amp;fields=name_text&amp;qwordsphrase=&ldquo;Davy Jones&rdquo;</a></p>

<p>The Monkees are again on top! Party like it&rsquo;s 1967!</p>

<h3 id="where-it-breaks-down">Where it breaks down</h3>

<p>If you actually have a phrase as one of your query terms, it will no longer be treated as a phrase during the boost because we&rsquo;re getting rid of all the double-quotes.</p>

<p>And, of course, if you&rsquo;ve got gobs of full-text and include your fulltext field, setting  query slop to 999 isn&rsquo;t just a cute trick, it&rsquo;s a cute trick that will melt your servers to slag and still not do what you want it to do.</p>

<h3 id="what-have-we-learned">What have we learned?</h3>

<ul>
<li>Solr doesn&rsquo;t really separate multiple values from each other in a <code>multiValued</code> field</li>
<li>Phrase slop (<code>ps</code>) and query slop (<code>qs</code>) can be used to allow &ldquo;phrase&rdquo; to mean &ldquo;a bunch of tokens within X spots of each other&rdquo;</li>
<li><em>I&rsquo;m A Believer</em> is the best song Neil Diamond ever wrote.</li>
</ul>

	</article>
	<br>
	
</main>
	


						<br>
						<section id="footer">
							<div class="text-center center-block">
								<ul class="copyright">
									<li>&copy; 2017 <a target="_blank" href="http://robotlibrarian.billdueber.com"></a> | Powered by <a target="_blank" href="https://gohugo.io/">Gohugo</a> | Theme <a target="_blank" href="https://git.pofilo.fr/pofilo/hugo-fatboy">Fatboy</a></li>
								</ul>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
	</div>
  
  
	
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

	

	

	

	

	
	</body>
</html>





