<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="description" content="">
	<meta property="og:title" content="Benchmarking MARC record parsing in Ruby">
	<link rel="icon" href="http://robotlibrarian.billdueber.com/" />
	
	
		<title>Robot Librarian | Benchmarking MARC record parsing in Ruby</title>
		<meta property="og:type" content="article">
		<meta property="article:published_time" content= 2009-09-17 >
	
	<meta property="og:description" content="">
	<meta property="og:url" content="http://robotlibrarian.billdueber.com/2009/09/benchmarking-marc-record-parsing-in-ruby/">
	<meta property="og:site_name" content="Robot Librarian">
	
	<meta name="generator" content="Hugo 0.24.1" />
   
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

	
	<link rel="stylesheet" href="http://robotlibrarian.billdueber.comcss/style.css">
	<link href="" rel="alternate" type="application/rss+xml" title="Robot Librarian" />
</head>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://robotlibrarian.billdueber.com">Robot Librarian</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="particles-js"></div>
	<div id="menu-content" class="vertical-align">
		<img src="/images/robot_alpha.png" class="center-block" alt="Cheesy picture of robot">
		
			<h1 class="text-center"><a href="http://robotlibrarian.billdueber.com">Robot Librarian</a></h1>
		
		
		
			<small class="text-center center-block">Bill Dueber</small>
		
		
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/billdueber" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>
				
			
			
			
			<a href="https://github.com/https://github.com/billdueber" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
				
			<a href="mailto:bill@dueber.com" target="_blank"><i class="fa fa-envelope fa-2x"></i></a>			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>


		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<div class="panel-header">
			<h1>Benchmarking MARC record parsing in Ruby
				
			</h1>
			<div class="panel-footer">
				
			</div>
			
		</div>
	</header>
	<br>
	<HR align=center>
	<article>
		

<p>[Note: since I started writing this, I found out Bess &amp; Co. store MARC-XML. That makes a difference, since XML in Ruby can be really, really slow]</p>

<p>[<strong>UPADTE</strong> It turns out they <em>don&rsquo;t</em> use MARC-XML. They use MARC-Binary just like the rest of us. Oops. ]</p>

<p>[<strong>UP-UPDATE</strong> Well, no, they <em>do</em> use MARC-XML. I&rsquo;m not afraid to constantly change my story. This is why I&rsquo;m the best investigative reporter in the business]</p>

<p>The other day on the blacklight mailing list, Bess Sadler wrote</p>

<blockquote>
<p>Yes, we do still include the full marc record, but the rule of thumb we&rsquo;re currently using is that anything that needs to display in the index view (the search results) needs to be broken out into a separate display field, because retrieving and parsing marc records for every item in a list of search results is too much of a performance hit.</p>
</blockquote>

<p>This surprised me a fair bit, because in our implementation of VuFind (which uses PHP, versus Ruby for Blacklight) I do just that &ndash; grab the MARC out of Solr, parse it, and pull stuff like full titles and such out of it.</p>

<p>As it turns out, I&rsquo;d been screwing around with calling marc4j from jruby, anyway, so I threw that into the mix, and here&rsquo;s what I found.</p>

<h3 id="what-the-benchmark-tries-to-measure">What the benchmark tries to measure</h3>

<p>The focus is on measuring time to parse MARC records as returned in a field from Solr in MARC-binary.</p>

<p>I got 40 sets of 50 records each (2000 records) from our Solr instance in ruby format and extracted the binary MARC strings. This resulted in an array of 40 sets of 50 strings, each of which is a valid MARC record.</p>

<p>Fifty records seems largish to me &ndash; we only display 20 at a time &ndash; but thought I&rsquo;d swing for the fences.</p>

<p>I&rsquo;m testing along three(ish) dimensions:</p>

<ul>
<li>jruby vs mri</li>
<li>marc4j vs ruby-marc (only on jruby, obviously)</li>
<li>parsing each string individually, or globbing them all together and treating it as if it&rsquo;s a multi-record file</li>
</ul>

<p>[Note that MRI is using Net::HTTP to get the data; I presume Curl would be faster still. It&rsquo;s already faster than jruby]</p>

<p>The following data show the average time to parse out each set of 50 records and extract the first 245 (title) field from each one, along with the totals for doing all 2000 records.</p>

<pre><code>Method                           User       Total      Real

jruby Get/Eval data              0.134750   0.134750 (  0.134850)
jruby Get/Eval data (2000)       5.390000   5.390000 (  5.394000)

MRI Get/Eval data                0.008500   0.012750 (  0.115942)
MRI Get/Eval data (2000)         0.340000   0.510000 (  4.637677)

jruby-marc4j-oneAtATime          0.056075   0.056075  (0.056125)
jruby-marc4j-multistring         0.027925   0.027925  (0.028000)

jruby-marc-oneAtATime            0.066625   0.066625  (0.066650)
jruby-marc-multistring           0.034300   0.034300  (0.034325)

mri-marc-oneAtATime              0.084500   0.085250  (0.086597)
mri-marc-multistring             0.085000   0.085750  (0.086026)

jruby-marc4j-oneAtATime (2000)   2.243000   2.243000  (2.244999)
jruby-marc-oneAtATime (2000)     2.665001   2.665001  (2.666000)
mri-marc-oneAtATime (2000)       3.380000   3.410000  (3.463888)


jruby-marc4j-multistring (2000)  1.117001   1.117001  (1.120001)
jruby-marc-multistring (2000)    1.371999   1.371999  (1.372999)
mri-marc-multistring (2000)      3.400000   3.430000  (3.441052)
</code></pre>

<p>So&hellip;the worst-case scenario is taking an average 0.085 second to get the first title field out of <strong>each one of 50 binary MARC records</strong> once we&rsquo;ve got them.</p>

<p>Now, I&rsquo;m sure all my records came out of the cache, so my query time wasn&rsquo;t very long. But we still end up with a maximum of roughly 0.2 seconds plus the time to actually do the query to end up with a set of 50 marc records.</p>

<p>We can see from looking at the totals that it looks like MRI&rsquo;s bottleneck is
the actual parsing, whereas constructing the input streams is expensive under jruby (at least the way I&rsquo;m doing it), resulting in a benefit of concatenating them all together into one longish string before parsing.</p>

<p>Marc4j is faster (20%ish), but not enough faster to be worth the effort in my mind. Keep in mind that I have no idea how fast Marc4j is when running under pure java, without all the jruby overhead.</p>

<p>Bottom line, though: that seems fast enough to me.</p>

<p>I&rsquo;ll try to benchmark with XML later on today or tomorrow.</p>

	</article>
	<br>
	
</main>
	


						<br>
						<section id="footer">
							<div class="text-center center-block">
								<ul class="copyright">
									<li>&copy; 2017 <a target="_blank" href="http://robotlibrarian.billdueber.com"></a> | Powered by <a target="_blank" href="https://gohugo.io/">Gohugo</a> | Theme <a target="_blank" href="https://git.pofilo.fr/pofilo/hugo-fatboy">Fatboy</a></li>
								</ul>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
	</div>
  
  
	
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

	

	

	

	

	
	</body>
</html>





