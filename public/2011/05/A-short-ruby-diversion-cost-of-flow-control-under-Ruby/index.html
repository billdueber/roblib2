<!DOCTYPE html>
<html lang="en">
<head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# website: http://ogp.me/ns/website#">
	<meta http-equiv="content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
	<meta name="description" content="">
	<meta property="og:title" content="A short ruby diversion: cost of flow control under Ruby">
	<link rel="icon" href="http://robotlibrarian.billdueber.com/" />
	
	
		<title>Robot Librarian | A short ruby diversion: cost of flow control under Ruby</title>
		<meta property="og:type" content="article">
		<meta property="article:published_time" content= 2011-05-03 >
	
	<meta property="og:description" content="">
	<meta property="og:url" content="http://robotlibrarian.billdueber.com/2011/05/a-short-ruby-diversion-cost-of-flow-control-under-ruby/">
	<meta property="og:site_name" content="Robot Librarian">
	
		<meta property="og:tags" content="ruby">
	
	<meta name="generator" content="Hugo 0.24.1" />
   
	
	<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.min.css">

	
	<link rel="stylesheet" href="http://robotlibrarian.billdueber.comcss/style.css">
	<link href="" rel="alternate" type="application/rss+xml" title="Robot Librarian" />
</head>
<nav class="navbar navbar-default navbar-fixed-top visible-xs">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			
				<a class="navbar-brand" href="http://robotlibrarian.billdueber.com">Robot Librarian</a>
			
		</div>
		<div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
			<ul class="nav navbar-nav">
				
				
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid">
	<div class="row">
		<div id="menu" class="hidden-xs col-sm-4 col-md-3">
	<div id="particles-js"></div>
	<div id="menu-content" class="vertical-align">
		<img src="/images/robot_alpha.png" class="center-block" alt="Cheesy picture of robot">
		
			<h1 class="text-center"><a href="http://robotlibrarian.billdueber.com">Robot Librarian</a></h1>
		
		
		
			<small class="text-center center-block">Bill Dueber</small>
		
		
		
		<div id="social" class="text-center">
			<a href="https://twitter.com/billdueber" target="_blank"><i class="fa fa-twitter fa-2x"></i></a>
				
			
			
			
			<a href="https://github.com/https://github.com/billdueber" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
			
				
			<a href="mailto:bill@dueber.com" target="_blank"><i class="fa fa-envelope fa-2x"></i></a>			
		</div>
		<div id="links" class="text-center">
			
			
		</div>
	</div>
</div>


		<div id="content" class="col-xs-12 col-sm-8 col-md-9">
			<div class="row">
				<div id="post" class="col-sm-offset-1 col-sm-10 col-md-10 col-lg-8">

<main>
	<header>
		<div class="panel-header">
			<h1>A short ruby diversion: cost of flow control under Ruby
				
			</h1>
			<div class="panel-footer">
				
					<small class="text-muted">
						
						
							<font size="4"><a href="http://robotlibrarian.billdueber.comtags/ruby"><span class="label label-success">ruby</span></a></font>
						
					</small>
				
			</div>
			
		</div>
	</header>
	<br>
	<HR align=center>
	<article>
		<p>A couple days ago I decided to finally get back to working on <a href="https://github.com/billdueber/threach"><code>threach</code></a> to try to deal with problems it had &ndash; essentially, it didn&rsquo;t deal well with non-local exits due to calls to <code>break</code> or even something simple like a <code>NoMethodError</code>.</p>

<p>[BTW, I think I managed it. As near as I can tell, <code>threach</code> version 0.4 won&rsquo;t deadlock anymore]</p>

<p>Along the way, while trying to figure out how threads affect the behavior of different non-local exits, I noticed that in some cases there was still work being done by one or more threads long after there was an exception raised.</p>

<p>I re-discovered something that a lot of people already know: <code>raise</code>/<code>rescue</code> under MRI is slow, and under JRuby can be <em>unbearably</em> slow. How slow?</p>

<p>Let&rsquo;s look at four simple blocks that exercise four different block exit strategies: <code>break</code>, <code>catch</code> and <code>throw</code>, <code>raise</code> with the normal single (or zero) arguments, as well as the three-argument version of <code>raise</code>.</p>

<table class="data">
  <tr>
    <th>Simple break</th><th>Catch/Throw</th>
  </tr>
  <tr>
    <td>
      <pre lang="ruby">
range.each do |i|
  break
end
      </pre>
    </td>
    <td>
      <pre lang="ruby">
catch(:benchmarking) do  
 range.each do |i|
   throw(:benchmarking)
 end
end
      </pre>
    </td>
  </tr>
  <tr>
    <th>Raise (1 arg)</th><th>Raise (3 args)</th>
  </tr>
  <tr>
    <td>
      <pre lang="ruby">
 begin
   range.each do |i|
     raise StandardError
   end
 rescue
  # do nothing
 end
     </pre>
    </td>
    <td>
      <pre lang="ruby">
begin
  range.each do |i|
    raise StandardError, :hi, nil
  end
rescue
 # do nothing
end
      </pre>
    </td>
  </tr>
</table>

<p>In each case, we immediately exit the block without doing any work; the idea is to measure how long it takes to break out for each case.</p>

<p>So&hellip;.let&rsquo;s run them each 100K times and see what happens, shall we? Times are in seconds, averaged over two runs.</p>

<table class="data" id="t">
  <tr>
    <th></th><th>Ruby 1.8</th><th>Ruby 1.9</th><th>JRuby</th><th>JRuby --1.9</th>
  </tr>  
  <tr><th>break</th>        <td>0.12</td><td>0.07</td><td>0.29</td> <td>0.21</td></tr>
  <tr><th>catch/throw</th>  <td>0.35</td><td>0.28</td><td>0.64</td> <td>0.48</td></tr>
  <tr><th>raise (1 arg)</th><td>1.78</td><td>2.10</td><td class="bad">26.60</td><td class="bad">22.06</td></tr>
  <tr><th>raise (3 arg)</th><td>1.85</td><td>2.13</td><td>0.45</td> <td>0.45</td></tr>
</table>

<p>The first thing to note is that this is 100K iterations. Three of the strategies are fast enough that you&rsquo;d have to work really, really hard to notice them.</p>

<p>In terms of speed, <code>raise (3 args)</code>, <code>catch/throw</code>, and <code>break</code> are fast enough that you shouldn&rsquo;t bother worrying about them (although you <em>should</em> choose the method that makes your code easy to understand).</p>

<p>The second things to note is <em>Holy Camoli!</em> JRuby is slow there!</p>

<p><a href="http://jira.codehaus.org/browse/JRUBY-5534">This Jira ticket</a> tells the tale: The creation of the backtrace is very, very expensive for JRuby. That <code>nil</code> at the end of the <code>raise (3 args)</code> call suppresses the creation of that backtrace, so the speed is fine.</p>

<p>Three things worth saying here:</p>

<ul>
<li>If you&rsquo;re using <code>raise/rescue</code> for flow control, <em>you&rsquo;re already doing it wrong.</em> Reserve exceptions for, well, exceptional conditions that are only going to be raised once or twice, not all the time.</li>
<li>If you&rsquo;re writing code that, for some ungodly reason, is planning on raising a crapload of exceptions, use the three-arg version. I&rsquo;m looking at you, gem authors.</li>
<li>If you&rsquo;re writing your code without worrying about how it will work under multiple threads, well, please don&rsquo;t do that. Everyone has multi-core systems these days, and it&rsquo;s silly to not be able to use them. Plus, counting on Matz to never move to a VM with real threads is a big gamble.</li>
</ul>

	</article>
	<br>
	
</main>
	


						<br>
						<section id="footer">
							<div class="text-center center-block">
								<ul class="copyright">
									<li>&copy; 2017 <a target="_blank" href="http://robotlibrarian.billdueber.com"></a> | Powered by <a target="_blank" href="https://gohugo.io/">Gohugo</a> | Theme <a target="_blank" href="https://git.pofilo.fr/pofilo/hugo-fatboy">Fatboy</a></li>
								</ul>
							</div>
						</section>
					</div>
				</div>
			</div>
		</div>
	</div>
  
  
	
  
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.2/js/bootstrap.min.js"></script>

	

	

	

	

	
	</body>
</html>





